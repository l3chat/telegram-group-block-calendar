<!doctype html>
<html lang="ru">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Group Calendar</title>

  <!-- FullCalendar -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>

  <!-- Telegram WebApp SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root {
      --mine-bg: #c8f7c5;
      /* –∑–µ–ª—ë–Ω—ã–π ‚Äî –º–æ–∏ */
      --mine-border: #2e7d32;
      --theirs-bg: #ffd6cc;
      /* –∫–æ—Ä–∞–ª–ª–æ–≤—ã–π ‚Äî —á—É–∂–∏–µ */
      --theirs-border: #c62828;
    }

    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      margin: 0;
      background: #fff;
    }

    .wrap {
      max-width: 920px;
      margin: 0 auto;
      padding: 10px 12px 24px;
    }

    #legend {
      display: flex;
      gap: 16px;
      align-items: center;
      font-size: 14px;
      margin: 6px 2px 10px;
      color: #333;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .dot {
      width: 14px;
      height: 14px;
      border-radius: 4px;
      border: 1px solid;
      display: inline-block;
    }

    .dot.mine {
      background: var(--mine-bg);
      border-color: var(--mine-border);
    }

    .dot.theirs {
      background: var(--theirs-bg);
      border-color: var(--theirs-border);
    }

    /* colors */
    .fc-event.mine {
      background: #c8f7c5 !important;
      /* light green */
      border-color: #2e7d32 !important;
    }

    .fc-event.theirs {
      background: #ffd6cc !important;
      /* light coral */
      border-color: #c62828 !important;
    }

    /* force black text for both kinds */
    .fc-event.mine,
    .fc-event.mine .fc-event-main,
    .fc-event.theirs,
    .fc-event.theirs .fc-event-main,
    .fc-event-title {
      color: #000 !important;
      font-weight: 600;
    }

    .actions {
      display: flex;
      justify-content: center;
      margin-top: 12px;
      gap: 8px;
    }

    .btn {
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid #ccc;
      background: #f9f9f9;
      cursor: pointer;
      font-weight: 600;
    }

    .btn[disabled] {
      opacity: .5;
      cursor: not-allowed;
    }





    /* (optional, to make titles smaller and centered) */
    .fc-event-title {
      font-size: 0.8rem;
      text-align: center;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div id="legend">
      <span class="pill"><span class="dot mine"></span> –ú–æ–∏ –±—Ä–æ–Ω–∏</span>
      <span class="pill"><span class="dot theirs"></span> –ß—É–∂–∏–µ –±—Ä–æ–Ω–∏</span>
    </div>
    <div id="calendar"></div>
    <div class="actions">
      <button id="confirm" class="btn" disabled>‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –±—Ä–æ–Ω—å –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –¥–Ω—è</button>
      <button id="refresh" class="btn">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
    </div>
  </div>

  <script>
    // --- Telegram init (—Ç–µ–º–∞/–≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å)
    try { Telegram.WebApp.ready?.(); Telegram.WebApp.expand?.(); } catch { }

    const qs = new URLSearchParams(location.search);
    const CHAT_ID = qs.get('chat_id');          // –≥—Ä—É–ø–ø–∞/—Ç–µ–º–∞
    const TOPIC_ID = qs.get('topic_id') || '';   // –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
    const INGEST = qs.get('ingest') || '';     // POST –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è
    const UID_QS = Number(qs.get('uid') || '0');
    const UNAME_QS = qs.get('uname') || '—á–µ—Ä–µ–∑ WebApp';

    // –ï—Å–ª–∏ –∑–∞–ø—É—Å—Ç–∏–ª–∏ –≤ –≥—Ä—É–ø–ø–µ —á–µ—Ä–µ–∑ web_app-–∫–Ω–æ–ø–∫—É, —É –Ω–∞—Å –µ—â—ë –µ—Å—Ç—å initDataUnsafe
    const init = (window.Telegram && Telegram.WebApp && Telegram.WebApp.initDataUnsafe) || {};
    const fromUnsafe = init.user || null;

    const UID = fromUnsafe?.id ?? UID_QS;
    const UNAME = (fromUnsafe ? [fromUnsafe.first_name, fromUnsafe.last_name].filter(Boolean).join(' ').trim() : UNAME_QS) || '—á–µ—Ä–µ–∑ WebApp';

    // base URL –≤–æ—Ä–∫–µ—Ä–∞ –±–µ—Ä—ë–º –∏–∑ ingest (—Å—Ä–µ–∑–∞–µ–º /ingest)
    let apiBase = '';
    try {
      const u = new URL(INGEST);
      apiBase = u.origin + u.pathname.replace(/\/ingest\/?$/, '');
    } catch { }

    const BOOKINGS_URL = apiBase ? `${apiBase}/bookings?chat_id=${encodeURIComponent(CHAT_ID)}` : '';
    const CANCEL_URL = apiBase ? `${apiBase}/cancel_api` : '';

    const calendarEl = document.getElementById('calendar');
    const confirmBtn = document.getElementById('confirm');
    const refreshBtn = document.getElementById('refresh');

    const bookedMap = new Map();  // 'YYYY-MM-DD' -> { user_id, user_name }
    let selectedDate = null;
    let calendar = null;

    function toISODate(d) {
      const dt = (d instanceof Date) ? d : new Date(d);
      const y = dt.getFullYear();
      const m = String(dt.getMonth() + 1).padStart(2, '0');
      const dd = String(dt.getDate()).padStart(2, '0');
      return `${y}-${m}-${dd}`;
    }

    async function fetchBookings() {
      bookedMap.clear();
      if (!BOOKINGS_URL) return [];
      const res = await fetch(BOOKINGS_URL, { mode: 'cors' });
      const data = await res.json().catch(() => ({}));
      const arr = Array.isArray(data.bookings) ? data.bookings : [];
      for (const b of arr) {
        if (!b.date) continue;
        bookedMap.set(String(b.date), { user_id: Number(b.user_id || 0), user_name: b.user_name || '‚Äî' });
      }
      return arr;
    }

    function toEvents(arr) {
      return arr.map(b => {
        const mine = Number(b.user_id || 0) === UID;
        return {
          id: `d:${b.date}`,
          title: b.user_name || '‚Äî',
          start: b.date,
          end: addDaysISO(b.date, 1),     // allDay-¬´end¬ª —ç–∫—Å–∫–ª—é–∑–∏–≤–Ω–∞—è ‚Üí +1 –¥–µ–Ω—å
          allDay: true,
          display: 'block',
          classNames: [mine ? 'mine' : 'theirs']
        };
      });
    }

    async function reloadEvents() {
      const arr = await fetchBookings();
      const events = toEvents(arr);
      calendar.removeAllEvents();
      calendar.addEventSource(events);
      calendar.render();
    }

    function showPopup(title, message, buttons = []) {
      if (Telegram?.WebApp?.showPopup) {
        Telegram.WebApp.showPopup({ title, message, buttons: buttons.length ? buttons : [{ type: 'close' }] });
      } else {
        alert(`${title}\n\n${message}`);
      }
    }

    async function initCalendar() {
      const initial = toEvents(await fetchBookings());

      calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        height: 'auto',
        selectable: true,
        selectAllow: (info) => !bookedMap.has(toISODate(info.start)),

        dateClick: async (arg) => {
          const day = toISODate(arg.date);
          const b = bookedMap.get(day);
          if (b) {
            // if it's mine ‚Üí immediately cancel; otherwise ignore
            if (Number(b.user_id) === UID) {
              await cancelBooking(day);
              await reloadEvents();
            }
            return;
          }

          // <-- –ù–û–í–û–ï: —Å–≤–æ–±–æ–¥–Ω—ã–π –¥–µ–Ω—å ‚Äî –≤—ã–±–∏—Ä–∞–µ–º –µ–≥–æ –æ–¥–Ω–∏–º —Ç–∞–ø–æ–º
          selectedDate = day;
          confirmBtn.disabled = false;
          // –≤–∏–∑—É–∞–ª—å–Ω–æ –ø–æ–¥—Å–≤–µ—Ç–∏–º –≤—ã–±–æ—Ä
          calendar.select({ start: day, end: addDaysISO(day, 1), allDay: true });

        },
        select: (info) => {
          selectedDate = toISODate(info.start);
          confirmBtn.disabled = !selectedDate;
        },
        unselect: () => { selectedDate = null; confirmBtn.disabled = true; },
        selectLongPressDelay: 0,   // –Ω–∞ –º–æ–±–∏–ª—å–Ω–æ–º –Ω–µ –∂–¥–∞—Ç—å ¬´–¥–æ–ª–≥–æ–≥–æ –∫–∞—Å–∞–Ω–∏—è¬ª        
        events: initial,
        headerToolbar: { left: 'prev,next today', center: 'title', right: '' }
      });

      calendar.render();
    }




    async function bookSelected() {
      if (!selectedDate) {
        showPopup('–ù–µ—Ç –¥–∞—Ç—ã', '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Å–≤–æ–±–æ–¥–Ω—ã–π –¥–µ–Ω—å.');
        return;
      }

      const payload = {
        type: 'book',
        chat_id: CHAT_ID,
        topic_id: TOPIC_ID || undefined,
        date: selectedDate,
        user_id: UID || 0,
        user_name: UNAME || '—á–µ—Ä–µ–∑ WebApp'
      };

      console.log('[BOOK] intent', payload);

      // 1) –ü—ã—Ç–∞–µ–º—Å—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —á–µ—Ä–µ–∑ Telegram WebApp (–µ—Å–ª–∏ –≤–Ω—É—Ç—Ä–∏ Telegram)
      let viaSendData = false;
      try {
        if (window.Telegram?.WebApp?.sendData) {
          Telegram.WebApp.sendData(JSON.stringify(payload));
          viaSendData = true;
          console.log('[BOOK] sent via sendData');
        }
      } catch (e) {
        console.warn('[BOOK] sendData error', e);
      }

      // 2) –ù–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –∏—Å—Ö–æ–¥–∞ ‚Äî –¥—É–±–ª—å –Ω–∞–ø—Ä—è–º—É—é –≤ –≤–æ—Ä–∫–µ—Ä (–∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ)
      let viaFetch = false;
      if (INGEST) {
        try {
          const r = await fetch(INGEST, {
            method: 'POST',
            mode: 'cors',
            credentials: 'omit',
            headers: { 'content-type': 'application/json' },
            body: JSON.stringify(payload),
          });
          console.log('[BOOK] fetch status', r.status);
          viaFetch = r.ok;
        } catch (e) {
          console.error('[BOOK] fetch error', e);
        }
      } else {
        console.warn('[BOOK] no INGEST url present');
      }

      const delivered = viaSendData || viaFetch;

      if (delivered) {
        selectedDate = null;
        confirmBtn.disabled = true;
        await reloadEvents();
      } else {
        console.warn('[BOOK] delivery failed');
      }
    }







    (async () => {
      try { await initCalendar(); }
      catch (e) { console.error('initCalendar failed', e); alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–∞–ª–µ–Ω–¥–∞—Ä—å.'); return; }
      confirmBtn.addEventListener('click', bookSelected);
      refreshBtn.addEventListener('click', reloadEvents);
    })();



    async function bookSelectedOld() {
      if (!selectedDate) return;

      // –ü–æ–ø—ã—Ç–∫–∞ –ø–æ—Å–ª–∞—Ç—å —á–µ—Ä–µ–∑ sendData (–µ—Å–ª–∏ –∑–∞–ø—É—â–µ–Ω–æ –∫–∞–∫ WebApp)
      const payload = {
        type: 'book',
        chat_id: CHAT_ID,
        topic_id: TOPIC_ID || undefined,
        date: selectedDate,
        user_id: UID || 0,
        user_name: UNAME || '—á–µ—Ä–µ–∑ WebApp'
      };

      let ok = false;
      try {
        if (Telegram?.WebApp?.sendData) {
          Telegram.WebApp.sendData(JSON.stringify(payload));
          ok = true;
        }
      } catch { }

      // Fallback ‚Äî –ø—Ä—è–º–æ–π POST –≤ –≤–æ—Ä–∫–µ—Ä
      if (!ok && INGEST) {
        try {
          await fetch(INGEST, {
            method: 'POST', headers: { 'content-type': 'application/json' },
            body: JSON.stringify(payload)
          });
          ok = true;
        } catch { }
      }

      if (ok) {
        selectedDate = null;
        confirmBtn.disabled = true;
        await reloadEvents();
        showPopup('–ì–æ—Ç–æ–≤–æ', '–ë—Ä–æ–Ω—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞.');
        Telegram?.WebApp?.close?.(); // –º–æ–∂–Ω–æ –∑–∞–∫—Ä—ã—Ç—å, –µ—Å–ª–∏ —Ö–æ—á–µ—Ç—Å—è
      } else {
        showPopup('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –±—Ä–æ–Ω—å.');
      }
    }

    async function cancelBooking(day) {
      if (!CANCEL_URL) return showPopup('–û—à–∏–±–∫–∞', '–ù–µ—Ç API –¥–ª—è –æ—Ç–º–µ–Ω—ã.');
      try {
        const r = await fetch(CANCEL_URL, {
          method: 'POST', headers: { 'content-type': 'application/json' },
          body: JSON.stringify({ chat_id: CHAT_ID, date: day, user_id: UID })
        });
        const j = await r.json();
        if (j?.ok) {
          await reloadEvents();
          showPopup('–°–Ω—è—Ç–æ', `–ë—Ä–æ–Ω—å –Ω–∞ ${day} —É–¥–∞–ª–µ–Ω–∞.`);
        } else if (j?.error === 'forbidden') {
          showPopup('–ù–µ—Ç –ø—Ä–∞–≤', '–≠—Ç—É –±—Ä–æ–Ω—å –º–æ–∂–µ—Ç —Å–Ω—è—Ç—å —Ç–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü –∏–ª–∏ –∞–¥–º–∏–Ω.');
        } else if (j?.error === 'not-found') {
          showPopup('–ù–µ—Ç –±—Ä–æ–Ω–∏', '–ù–∞ —ç—Ç—É –¥–∞—Ç—É –Ω–µ—Ç –±—Ä–æ–Ω–∏.');
        } else {
          showPopup('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–Ω—è—Ç—å –±—Ä–æ–Ω—å.');
        }
      } catch {
        showPopup('–û—à–∏–±–∫–∞', '–°–µ—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞.');
      }
    }



    function addDaysISO(iso, d = 1) {
      const dt = new Date(iso);
      dt.setDate(dt.getDate() + d);
      return toISODate(dt);
    }


    // init
    //    await initCalendar();
    //
    //    confirmBtn.addEventListener('click', bookSelected);
    //    refreshBtn.addEventListener('click', reloadEvents);

    (async () => {
      try {
        await initCalendar();
      } catch (e) {
        console.error('initCalendar failed', e);
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–∞–ª–µ–Ω–¥–∞—Ä—å.');
        return;
      }
      confirmBtn.addEventListener('click', bookSelected);
      refreshBtn.addEventListener('click', reloadEvents);
    })();
  </script>
</body>

</html>