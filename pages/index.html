<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Group Calendar (Telegram Mini App)</title>

  <!-- Telegram Mini Apps JS -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- FullCalendar (CDN) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/6.1.19/index.global.min.css"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/6.1.19/index.global.min.js"></script>

  <style>
    html, body { height:100%; margin:0; font-family:system-ui, sans-serif; }
    #wrap { padding: 12px; max-width: 980px; margin: 0 auto; }
    #warn { padding: 8px 12px; border-radius: 8px; background:#fff3cd; color:#664d03; display:none; }
    #calendar { margin-top: 8px; }
    .muted { color:#6b7280; font-size: 0.9rem; }
  </style>
</head>
<body>
<div id="wrap">
  <h3>–ì—Ä—É–ø–ø–æ–≤–æ–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å</h3>
  <div id="warn">–ü–æ—Ö–æ–∂–µ, –∫–∞–ª–µ–Ω–¥–∞—Ä—å –æ—Ç–∫—Ä—ã—Ç –Ω–µ —á–µ—Ä–µ–∑ Telegram. –í–µ—Ä–Ω–∏—Å—å –≤ —á–∞—Ç –∏ –Ω–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É –±–æ—Ç–∞ ‚ÄúüìÖ Open Calendar‚Äù.</div>
  <p class="muted">–ö–æ—Å–Ω–∏—Å—å –¥–∞—Ç—ã, –∑–∞—Ç–µ–º –Ω–∞–∂–º–∏ –∑–µ–ª—ë–Ω—É—é –∫–Ω–æ–ø–∫—É —Å–Ω–∏–∑—É (—Å–∏—Å—Ç–µ–º–Ω–∞—è –∫–Ω–æ–ø–∫–∞ Telegram).</p>
  <div id="calendar"></div>
</div>

<script>
  // --- Telegram bootstrap ---
  const tg = window.Telegram?.WebApp || null;
  if (tg) {
    try { tg.ready(); } catch {}
    try { tg.expand(); } catch {}
    document.body.style.background = tg.themeParams?.bg_color || "#fff";
  } else {
    document.getElementById('warn').style.display = 'block';
  }

  const qp       = new URLSearchParams(location.search);
  const chatId   = qp.get("chat_id");
  const topicId  = qp.get("topic_id");             // –º–æ–∂–µ—Ç –±—ã—Ç—å null
  const ingestUrl= qp.get("ingest");               // URL –≤–æ—Ä–∫–µ—Ä–∞ /ingest (–º–æ–∂–µ—Ç –±—ã—Ç—å null)

  // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–∑ –æ–∫—Ä—É–∂–µ–Ω–∏—è Mini App
  const tgUser   = window.Telegram?.WebApp?.initDataUnsafe?.user || null;
  const tg_uid   = tgUser?.id ?? null;
  const tg_name  = tgUser
    ? ([tgUser.first_name, tgUser.last_name].filter(Boolean).join(' ').trim()
       || (tgUser.username ? '@' + tgUser.username : null))
    : null;

  // –ü–æ–¥—Å–∫–∞–∑–∫–∞ –∏–∑ deep-link (–≤–æ—Ä–∫–µ—Ä –¥–æ–±–∞–≤–ª—è–µ—Ç uid/uname)
  const hint_uid  = qp.get('uid');
  const hint_name = qp.get('uname');

  // –ò—Ç–æ–≥–æ–≤–∞—è –∏–¥–µ–Ω—Ç–∏—á–Ω–æ—Å—Ç—å
  const user_id   = tg_uid ?? (hint_uid ? Number(hint_uid) : null);
  const user_name = tg_name || (hint_name || null) || null;

  let selectedDate = null;
  let detachMainBtn = null;

  function attachMainButton(handler) {
    try { tg?.offEvent?.('mainButtonClicked', handler); } catch {}
    try { tg?.MainButton?.offClick?.(handler); } catch {}
    try { tg?.onEvent?.('mainButtonClicked', handler); } catch {}
    try { tg?.MainButton?.onClick?.(handler); } catch {}
    return () => {
      try { tg?.offEvent?.('mainButtonClicked', handler); } catch {}
      try { tg?.MainButton?.offClick?.(handler); } catch {}
    };
  }

  function showMainButton(dateStr) {
    if (!tg) return;
    selectedDate = dateStr;
    try {
      tg.MainButton.setText(`–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å ${selectedDate}`);
      tg.MainButton.enable();
      tg.MainButton.show();
    } catch {}

    if (detachMainBtn) detachMainBtn();
    detachMainBtn = attachMainButton(async () => {
      if (!selectedDate) return;

      const payload = {
        type: 'book',
        chat_id: chatId,
        topic_id: topicId,
        date: selectedDate,
        user_id: user_id,
        user_name: user_name
      };

      // 1) –æ—Å–Ω–æ–≤–Ω–æ–π –ø—É—Ç—å Mini Apps
      try { tg.sendData(JSON.stringify(payload)); } catch {}

      // 2) —Ä–µ–∑–µ—Ä–≤ ‚Äî –ø—Ä—è–º–æ–π POST –Ω–∞ –≤–æ—Ä–∫–µ—Ä (/ingest) —Å CORS
      if (ingestUrl) {
        try {
          await fetch(ingestUrl, {
            method: 'POST',
            headers: { 'content-type': 'application/json' },
            body: JSON.stringify(payload)
          });
        } catch {}
      }

      // 3) –∑–∞–∫—Ä—ã–≤–∞–µ–º WebApp ‚Äî –ø–æ–º–æ–≥–∞–µ—Ç –¥–æ—Å—Ç–∞–≤–∫–µ –Ω–∞ —á–∞—Å—Ç–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤
      try { tg.close(); } catch {}

      // –≤–∏–∑—É–∞–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å
      try { tg.HapticFeedback?.impactOccurred?.('light'); } catch {}
      try { tg.showPopup?.({ title: "–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ", message: `–î–∞—Ç–∞: ${selectedDate}`, buttons:[{type:"close"}] }); } catch {}
    });
  }

  document.addEventListener('DOMContentLoaded', () => {
    const calendarEl = document.getElementById('calendar');
    const calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: 'dayGridMonth',
      height: 'auto',
      locale: 'ru',
      selectable: true,
      dateClick: (info) => { showMainButton(info.dateStr); },               // –º–æ–±–∏–ª—å–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π
      select: (selectionInfo) => { showMainButton(selectionInfo.startStr); }, // –¥–µ—Å–∫—Ç–æ–ø
      unselectAuto: true
    });
    calendar.render();
  });
</script>
</body>
</html>
